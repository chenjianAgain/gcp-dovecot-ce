
Resources:
      
  Ec2Instance:
    Type: 'AWS::EC2::Instance'
    Properties:
      KeyName: Joseph-demo
      ImageId: ami-b70554c8
      SecurityGroups:
        - all-traffic-allowed
        - default
      SpotPrice: !Ref SpotPrice
      InstanceType: !Ref SpotInstanceType
      # InstanceType: !FindInMap [InstanceSize, !Ref EnvironmentSize, EC2]
      UserData:
        "Fn::Base64":
          !Sub |
          #!/bin/bash
          # yum update -y
          yum install -y mailx telnet mutt dovecot amazon-efs-utils aws-cfn-bootstrap 
          mnt_efs=/mnt/efs
          mkdir -p $mnt_efs
          mount -t efs fs-efbb24a7:/ $mnt_efs
          useradd demo
          echo "demo:demo1" | chpasswd
          usermod -aG mail demo
          sed -i '$adisable_plaintext_auth = no' /etc/dovecot/conf.d/10-auth.conf
          # Change local storage to efs for dovecot
          sed -i "\$amail_location = mbox:~/mail:INBOX=$mnt_efs/mail/%u" /etc/dovecot/conf.d/10-mail.conf
          systemctl restart dovecot
  
