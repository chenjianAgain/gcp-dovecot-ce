AWSTemplateFormatVersion: 2010-09-09
Description: AWS NLB PoC Demo
Parameters:
  VpcId:
    Type: 'AWS::EC2::VPC::Id'
    Description: Select a default VPC ID.
  SubnetID:
    Type: 'List<AWS::EC2::Subnet::Id>'
    Description: Select a default subnet ID in your selected VPC.
Resources:
  Ec2SecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: EC2 Security Group
      VpcId: !Ref VpcId
  ingress1:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      GroupId: !Ref Ec2SecurityGroup
      IpProtocol: tcp
      FromPort: 110
      ToPort: 110
      CidrIp: 0.0.0.0/0
  ingress2:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      GroupId: !Ref Ec2SecurityGroup
      IpProtocol: tcp
      FromPort: 143
      ToPort: 143
      CidrIp: 0.0.0.0/0
  EC2AutoScalingGroup:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      VPCZoneIdentifier: !Ref SubnetID
      LaunchConfigurationName: !Ref Ec2Instance
      MinSize: 0
      MaxSize: 1
      DesiredCapacity: 1
      HealthCheckGracePeriod: 300
      TargetGroupARNs:
        - !Ref publicNLBTargetGroup
      Tags:
        - Key: Name
          Value: "Joseph-Demo-20180620"
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService: '0'
        MaxBatchSize: '1'
        PauseTime: PT15M
        WaitOnResourceSignals: 'true'
  Ec2Instance:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      ImageId: !GetAtt AMIInfo.Id
      SecurityGroups:
        - !Ref Ec2SecurityGroup
      SpotPrice: !Ref SpotPrice
      InstanceType: !Ref SpotInstanceType
      KeyName: !Ref KeyName
      AssociatePublicIpAddress: 'true'
      UserData:
        'Fn::Base64': !Sub >
          #!/bin/bash
          yum update -y
          yum install -y mailx telnet mutt dovecot
          useradd demo
          echo "demo:demo1" | chpasswd
          usermod -aG mail demo
          sed -i '$adisable_plaintext_auth = no' /etc/dovecot/conf.d/10-auth.conf
          sed -i '$amail_location = mbox:~/mail:INBOX=/var/mail/%u' /etc/dovecot/conf.d/10-mail.conf
          systemctl restart dovecot
          # Prepare some data for imap/pop3 test
          for i in {1..3}
          do
              #echo "Welcome $i times"
              echo hello$i | mail -s "test$i" demo@localhost.
          done
          
  publicNLB:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Type: network
      Name: !Sub 
        - '${StackName}-nlb'
        - StackName: !Ref 'AWS::StackName'
      Scheme: internet-facing
      Subnets: !Ref SubnetID
      Tags:
        - Key: Name
          Value: !Sub 
            - '${StackName}-alb'
            - StackName: !Ref 'AWS::StackName'
  NLBListener:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref publicNLBTargetGroup
      LoadBalancerArn: !Ref publicNLB
      Port: 143
      Protocol: TCP
  publicNLBTargetGroup:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Properties:
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: /
      HealthCheckProtocol: TCP
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2
      Matcher:
        HttpCode: 200-399
      Name: !Sub 
        - '${StackName}-http-tg'
        - StackName: !Ref 'AWS::StackName'
      Port: 143
      Protocol: TCP
      Tags:
        - Key: Name
          Value: alb-tg
      VpcId: !Ref VpcId
Outputs:
  URL:
    Description: Your NLB DNS URL
    Value: !Sub 
      - 'http://${DNSName}'
      - DNSName: !GetAtt publicNLB.DNSName
